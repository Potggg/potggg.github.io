<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>ì´ˆêµ¬ / ê°•í™” ì‹œë®¬ë ˆì´í„°</title>
<link rel="shortcut icon" href="#">
<script>
  (function() {
    const originalWarn = console.warn;
    console.warn = function(...args) {
      if (typeof args[0] === 'string' && (
        args[0].includes('cdn.tailwindcss.com') || 
        args[0].includes('in-browser Babel transformer')
      )) { return; }
      originalWarn.apply(console, args);
    };
  })();
</script>

<script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
<script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
<script src="https://unpkg.com/babel-standalone@6/babel.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.21/lodash.min.js"></script>
<script src="https://cdn.tailwindcss.com"></script>
<script>
    // Tailwindê°€ ê¸°ì¡´ ì‹œë®¬ë ˆì´í„° ìŠ¤íƒ€ì¼ì„ ì´ˆê¸°í™”í•˜ì§€ ì•Šë„ë¡ ì„¤ì •
    tailwind.config = {
        corePlugins: {
            preflight: false,
        }
    }
</script>

<script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.6.0/decimal.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
<style>
  /* === [ê³µí†µ ë° ì‹œë®¬ë ˆì´í„° ìŠ¤íƒ€ì¼] === */
  :root {
    --input-padding-y: 9px;
    --button-padding-y: 10px;
    --border-width: 1px;
  }
  body {
    background:#0b1426;
    color:#eaf2ff;
    font-family:'Noto Sans KR', sans-serif; 
    margin:0;
    padding:15px;
    text-align:center;
    font-size: 15px;
  }
  h1 {color:#ffd447;margin-bottom:15px;}

  /* íƒ­ ë²„íŠ¼ ì˜ì—­ */
  .tab-buttons{display:flex;justify-content:center;gap:10px;margin-bottom:15px; flex-wrap: wrap;}
  .tab-buttons button{
    /* ì„ íƒë˜ì§€ ì•Šì€ ë²„íŠ¼: í°ìƒ‰ ë°°ê²½, íšŒìƒ‰ ê¸€ì”¨, íšŒìƒ‰ í…Œë‘ë¦¬ (ë‹¤ë¥¸ ìŠ¤íƒ€ì¼ì„ ê°•ì œ ì˜¤ë²„ë¼ì´ë“œí•˜ê¸° ìœ„í•´ !important ì¶”ê°€) */
    background:rgba(15,25,45,0.9) !important; 
    border: 1px solid #ffd447 !important; 
    color:#ffd447 !important;
    
    font-weight:700;
    border-radius:10px;
    padding:10px 20px;
    cursor:pointer;
    transition:all .2s ease;
  }

  .tab-buttons button.active{
    /* ì„ íƒëœ ë²„íŠ¼: ë…¸ë€ìƒ‰ ë°°ê²½, ê²€ì€ìƒ‰ ê¸€ì”¨, ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ (ê°•ì œ ì˜¤ë²„ë¼ì´ë“œ) */
    background:#ffd447 !important;
    color:#111 !important;
    border: 1px solid #ffd447 !important;
  }
  
  /* íƒ­ ì»¨í…ì¸  */
  .tab-content{display:none;}
  .tab-content.active{display:block;}
  
  /* ê³µí†µ Input/Button (ì‹œë®¬ë ˆì´í„°ìš©) */
  input:not(.input-compact){background:rgba(15,25,45,0.9);color:#fff;border:1px solid #3ba4f7;padding:10px 14px;border-radius:8px;width:260px;margin-bottom:8px;}
  button:not(.px-3){background:#ffd447;color:#111;font-weight:700;border:none;border-radius:8px;padding:10px 14px;cursor:pointer;margin:4px;transition:all .2s ease;}
  button:hover{filter:brightness(1.1);}
  
  /* ê²€ìƒ‰ì°½ ê·¸ë£¹ */
  .search-group {display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: wrap;}
  #suggestions {display: flex; flex-wrap: wrap; justify-content: center; gap: 6px; max-width: 700px; margin: 8px auto 0;}

  /* ê²€ìƒ‰ ì¸í’‹/ë²„íŠ¼ ì˜¤ë²„ë¼ì´ë“œ */
  #petName {padding: var(--input-padding-y) 10px; font-size: 14px; border: var(--border-width) solid #3ba4f7; border-radius: 8px; background: #1e2b40; color: #fff; box-sizing: border-box; width: 240px; margin-bottom: 0 !important;}
  #btnSearch {padding: var(--button-padding-y) 14px; background: #3ba4f7; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0 !important;}
  #btnClearInput {padding: var(--button-padding-y) 14px; background: #4a5d7c; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0 !important;}
  
  #sgrade {font-size: 14px;}
  .panel{margin-top:10px;background:rgba(15,25,45,0.9);border:1px solid #24324b;border-radius:10px;padding:10px;display: inline-block;}
  
  .result, #poisonResult{margin-top:15px; text-align:left; display:none; background:rgba(15,25,45,0.85); border-radius:10px; padding:14px; border:1px solid #24324b; font-family:"JetBrains Mono",monospace; font-size: 14px; line-height: 1.8;}
  
  /* ì†Œìˆ˜ì  ê²°ê³¼ ê·¸ë¦¬ë“œ */
  .decimal-grid {display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 5px 5px; padding: 5px 0;}
  .decimal-grid span:nth-child(4n-3), .decimal-grid span:nth-child(4n-1) {text-align: left;}
  .decimal-grid span:nth-child(4n-2), .decimal-grid span:nth-child(4n) {text-align: right; padding-right: 5px;}
  
  #costDisplay{margin-top:10px;color:#ffd447;font-weight:700;}
  .plus{color:#ff6b81;font-weight:700;}
  .minus{color:#3ba4f7;font-weight:700;}
  .zero{color:#a9b5cc;}

  /* ê²½í—˜ì¹˜ ê³„ì‚°ê¸° ë ˆì´ì•„ì›ƒ */
  .wrapper{display:flex;justify-content:center;gap:10px;max-width:900px;margin:auto; flex-wrap: wrap;}
  .card{background:rgba(20,30,50,0.9);border:1px solid #24324b;border-radius:16px;padding:16px;box-shadow:0 0 12px rgba(25,60,100,.25);}
  .card h2 {margin-top: 0; margin-bottom: 15px;}
  #expTab .card:first-child {min-width: 300px; max-width: 450px;}
  #expTab .card:last-child {min-width: 300px; max-width: 300px;}
  
  /* ë§¹ë… ê³„ì‚°ê¸° ìŠ¤íƒ€ì¼ */
  #expTab .search-group {display: flex; justify-content: center; align-items: center; gap: 8px; flex-wrap: nowrap; margin-bottom: 0;}
  #poisonPetName {width: 180px; padding: var(--input-padding-y) 10px; font-size: 14px; border: var(--border-width) solid #3ba4f7; border-radius: 8px; background: #1e2b40; color: #fff; box-sizing: border-box; margin-bottom: 0;}
  #btnPoisonSearch {padding: var(--button-padding-y) 14px; background: #ffd447; color: #111; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 0;}

  label{color:#a9b5cc;font-weight:600;font-size:14px;}
  .row{display:grid;gap:6px;margin:0;}
  .input-grid {display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 10px; padding: 0;}
  input[type="number"]:not(.input-compact){width: auto; padding:10px 8px; border:1px solid #3ba4f7; border-radius:10px; background:rgba(15,25,45,0.85); color:#fff; outline:none; font-size:15px; margin-bottom: 0; text-align: center;}
  
  select {background:rgba(15,25,45,0.9); color:#fff; border:1px solid #3ba4f7; padding:10px 14px; border-radius:8px; width: auto; font-size: 14px; padding: 10px 12px;}
  .row.buttons{display:flex;justify-content:space-between;gap:10px;margin-top:8px;padding: 0;}
  .row.buttons button{flex:1;width:48%;padding:10px 0;border-radius:8px;font-weight:700;}
  .results{display:grid; grid-template-columns: 1fr 1fr; gap:8px; margin-top:10px; padding: 0;}
  .stat{background:rgba(15,25,45,0.9);border:1px solid #24324b;border-radius:14px;padding:8px;text-align:center;}
  .stat small{display:block;color:#a9b5cc;}
  .stat strong{display:block;margin-top:4px;font-size:13.3333px;color:#ffd447;}

  .result-header, .result-row {display: grid; grid-template-columns: repeat(4, 1fr); text-align: center; font-family: "JetBrains Mono", monospace; column-gap: 40px;}
  .result-header {color: #3ba4f7; font-weight: 700; margin-top: 6px; border-bottom: 1px solid #24324b; padding-bottom: 3px;}
  .result-row {margin-top: 4px;}
  
  /* ê°•í™” ì‹œë®¬ë ˆì´í„° ìŠ¤íƒ€ì¼ */
  #enhancementStats {display: flex; justify-content: center; gap: 10px; margin-top: 15px; flex-wrap: wrap;}
  .stat-box {background: #1e2b40; border: 1px solid #3ba4f7; border-radius: 8px; padding: 10px 15px; text-align: center; min-width: 100px;}
  .stat-box small {display: block; color: #a9b5cc; font-size: 12px;}
  .stat-box strong {display: block; font-size: 18px; color: #ffd447; margin-top: 2px;}
  #enhancementLog {margin-top: 5px; background: rgba(15, 25, 45, 0.85); border-radius: 10px; padding: 8px; border: 1px solid #24324b; font-family: "JetBrains Mono", monospace; font-size: 13px; line-height: 1.6; max-width: 500px; margin-left: auto; margin-right: auto; text-align: left; max-height: 350px; overflow-y: auto; display: none;}
  #enhancementLog b { color: #ffffff; }
  .enh-success { color: #00ffff; }
  .enh-fail { color: #ff6b81; }
  .enh-destroy { color: #ff00ff; }
  .enh-controls {display: flex; justify-content: center; gap: 15px; margin-top: 15px; flex-wrap: wrap; max-width: 560px; margin-left: auto; margin-right: auto;}
  .enh-controls .control-group {display: flex; flex-direction: column; align-items: center; flex: 1; min-width: 130px;}
  .enh-controls select {width: 100%; margin-left: 0;}
  .enh-controls label {margin-bottom: 5px; text-align: center;}

  /* === [í¬ì¸íŠ¸ ê³„ì‚°ê¸° ì „ìš© ìŠ¤íƒ€ì¼ (React)] === */
  /* ìš”ì²­ ë””ìì¸ ê¸°ë°˜ ë‹¤í¬ í…Œë§ˆ ì ìš© */

  #pointCalcRoot {
      /* ì‹œë®¬ë ˆì´í„° ê³µí†µ Dark Panel ìŠ¤íƒ€ì¼ ì‚¬ìš© */
      background: rgba(15, 25, 45, 0.9);
      border: 1px solid #24324b;
      border-radius: 10px;
      color: #eaf2ff; /* í°íŠ¸ ìƒ‰ìƒ ë°ê²Œ */
      
      width: 90%; 
      max-width: 400px; 
      margin: 10px auto;
      padding: 10px;
      font-family: 'Noto Sans KR', sans-serif;
      font-size: 11px;
  }

  /* ì¸í’‹ë°•ìŠ¤ ìŠ¤íƒ€ì¼: ë†’ì´ 22pxë¡œ ë‚©ì‘í•˜ê²Œ, ë‹¤í¬ í…Œë§ˆ */
  .input-compact {
      outline: none;
      font-size: 11px;
      height: 22px !important;
      padding: 0;
      color: #fff; /* ê¸€ì”¨ ìƒ‰ìƒ í°ìƒ‰ */
      border-radius: 4px;
      line-height: 20px;
      background-color: #1e2b40;
      border: 1px solid #3ba4f7;
  }
  .input-compact:focus {
      box-shadow: 0 0 0 1px #ffd447; /* í¬ì»¤ìŠ¤ ì‹œ ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ */
      border-color: #ffd447 !important;
      background-color: #1e2b40 !important;
      z-index: 10;
  }

  /* ReadOnly Result Input Style */
  #pointCalcRoot input[type=number][readonly], 
  #pointCalcRoot input[type=text][readonly] {
      background-color: #0d1629;
      color: #a9b5cc;
      border: 1px solid #1c263c !important;
      cursor: default;
  }

  /* Total Row (Strong Highlight) */
  .total-input-highlight input {
      background-color: #3ba4f7 !important; /* íŒŒë€ìƒ‰ ë°°ê²½ */
      color: #0b1426 !important; /* ê²€ì •ìƒ‰ í°íŠ¸ */
      border: 1px solid #ffd447 !important; /* ë…¸ë€ìƒ‰ í…Œë‘ë¦¬ */
      font-weight: 900 !important;
  }

  /* ìˆ«ì ì…ë ¥ì°½ í™”ì‚´í‘œ ì œê±° ë° ìŠ¤íƒ€ì¼ */
  #pointCalcRoot input[type=number], 
  #pointCalcRoot input[type=text] {
      -moz-appearance: textfield;
      width: 100%; 
      margin: 0;
      text-align: center;
      padding: 0 !important; 
      height: 22px !important; /* ë†’ì´ ê°•ì œ ê³ ì • */
  }
  #pointCalcRoot input.bg-white { background-color: #1e2b40 !important; } /* Editable Input background color */
  #pointCalcRoot input::-webkit-outer-spin-button,
  #pointCalcRoot input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

  /* ëª¨ë°”ì¼ ìµœì í™” */
  @media (max-width: 600px) {
    body {font-size: 14px; padding: 10px;}
    h1 {font-size: 22px; margin-bottom: 10px;}
    input:not(.input-compact), select {font-size: 14px !important; padding: 8px 10px !important;}
    
    .decimal-grid {grid-template-columns: auto 1fr; gap: 5px 10px;}
    #enhancementStats {display: grid; grid-template-columns: 1fr 1fr; gap: 10px; max-width: 400px; margin: 15px auto;}
    .enh-controls {flex-direction: row; justify-content: center; gap: 10px; max-width: 400px; margin: 15px auto;}
    .enh-controls .control-group {flex: 1; min-width: unset; flex-direction: column; align-items: center;}
    
    /* íƒ­ ë²„íŠ¼ ëª¨ë°”ì¼ ì¤„ë°”ê¿ˆ -> 2x2 Gridë¡œ ìˆ˜ì • */
    .tab-buttons { 
      display: grid; /* Grid ë ˆì´ì•„ì›ƒ ì ìš© */
      grid-template-columns: 1fr 1fr; /* 2ì—´ ì„¤ì • */
      gap: 8px; /* ê°„ê²© ì¡°ì • */
      margin-bottom: 15px; /* ê¸°ì¡´ ê°„ê²© ìœ ì§€ */
    }
    .tab-buttons button { 
      padding: 10px 5px; /* í„°ì¹˜ ì˜ì—­ í™•ë³´ ë° ë†’ì´ ì¡°ì • */ 
      font-size: 14px; /* ê¸€ê¼´ í¬ê¸° ì¡°ì • */
      width: auto; /* Grid itemì— ë§ê²Œ ì¡°ì • */
      flex-grow: unset; /* ê¸°ì¡´ flex-grow ì œê±° */
    }

    /* í¬ì¸íŠ¸ ê³„ì‚°ê¸° ëª¨ë°”ì¼ */
    #pointCalcRoot { padding: 10px; }
    
    /* ê²½í—˜ì¹˜ ê³„ì‚°ê¸° ì…ë ¥ ê·¸ë¦¬ë“œ */
    .input-grid {
        grid-template-columns: 1fr 1fr;
        gap: 8px;
    }
    #expTab input[type="number"] {
        width: 100%;
        box-sizing: border-box;
    }
    .row.buttons {
        padding: 0;
    }
    .results {
        padding: 0;
    }

    /* ê°•í™” ë¡œê·¸ */
    #enhancementLog {
        font-size: 12px;
        padding: 4px;
        line-height: 1.4;
        max-height: 250px;
        letter-spacing: -0.4px; 
    }

    /* ì´ˆêµ¬ ê²°ê³¼ ì°½ (#result)ì˜ ê°„ê²© ì¶•ì†Œ (ë§¹ë…ì€ ì œì™¸) */
    #result {
        font-size: 12px;
        line-height: 1.4 !important;
        letter-spacing: -0.5px !important;
  }
    
  }
  
  #notice {margin-top: 20px; font-size: 14px;}
</style>
</head>
<body>
<h1>ğŸ•¹ï¸ ë…¸ë°”ì„œë²„ ì‹œë®¬ë ˆì´í„°</h1>

<div class="tab-buttons">
  <button id="tabSim" class="active">ğŸ² ì´ˆêµ¬ ì‹œë®¬ë ˆì´í„°</button>
  <button id="tabEnh">ğŸ¹ ê°•í™” ì‹œë®¬ë ˆì´í„°</button> 
  <button id="tabExp">ğŸ“˜ ê²½í—˜ì¹˜ / ì†Œìˆ˜ì  ê³„ì‚°</button>
  <button id="tabPoint">ğŸ”„ í™˜í¬ ê³„ì‚°ê¸°</button>
</div>

<div id="simTab" class="tab-content active">
  <div class="search-group">
    <input id="petName" placeholder="ğŸ” í˜íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”." />
    <button id="btnSearch">ê²€ìƒ‰</button>
    <button id="btnClearInput">ì´ˆê¸°í™”</button>
  </div>
  <div id="suggestions" style="margin-top:8px;"></div>
  <div id="sgrade" class="panel">í˜íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ Sê¸‰ ê¸°ì¤€ ëŠ¥ë ¥ì¹˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.</div>
  <div style="margin-top:10px;">
    <button id="sim1">ğŸ² ì´ˆêµ¬ 1íšŒ</button>
    <button id="sim5">ğŸ² ì´ˆêµ¬ 5íšŒ</button>
    <button id="simUntil">ğŸ”¥ ì •ì„ ë½‘ê¸°</button>
    <button id="clear">ğŸ§¹</button>
  </div>
  <div id="costDisplay">ğŸ’° ì´ ì†Œëª¨ : 0ì›</div>
  <div id="result" class="result" style="display:none;"></div>
  <div id="notice">ì œì‘ë„ì›€ : ë…¸ë°”ì„œë²„ ì§€ì›(sup_bot)ë‹˜</div>
</div>

<div id="enhTab" class="tab-content">
  <div class="enh-controls">
    <div class="control-group">
        <label for="initialEnhancementLevel">ì‹œì‘ ë“±ê¸‰</label>
        <select id="initialEnhancementLevel">
            <option value="0">+0</option>
            <option value="1">+1</option>
            <option value="2">+2</option>
            <option value="3">+3</option>
            <option value="4">+4</option>
            <option value="5">+5</option>
            <option value="6">+6</option>
            <option value="7">+7</option>
            <option value="8">+8</option>
            <option value="9">+9</option>
        </select>
    </div>
    <div class="control-group">
        <label for="enhancementCube">ì‚¬ìš© íë¸Œ</label>
        <select id="enhancementCube">
            <option value="NORMAL_CUBE" data-rate-increase="0">ì¼ë°˜ íë¸Œ (+0%)</option>
            <option value="ADVANCED_CUBE" data-rate-increase="5">ê³ ê¸‰ íë¸Œ (+5%)</option>
        </select>
    </div>
    <div class="control-group">
        <label for="enhancementAid">ê°•í™” ë³´ì¡°ì œ</label>
        <select id="enhancementAid">
            <option value="NONE" data-rate-increase="0">ë¯¸ì‚¬ìš© (+0%)</option>
            <option value="AID_5" data-rate-increase="5">ê°•í™” ë³´ì¡°ì œ (+5%)</option>
            <option value="AID_10" data-rate-increase="10">ê°•í™” ë³´ì¡°ì œ (+10%)</option>
            <option value="AID_15" data-rate-increase="15">ê°•í™” ë³´ì¡°ì œ (+15%)</option>
            <option value="AID_20" data-rate-increase="20">ê°•í™” ë³´ì¡°ì œ (+20%)</option>
        </select>
    </div>
  </div>
  <div id="enhancementStats">
    <div class="stat-box"><small>í˜„ì¬ ë“±ê¸‰</small><strong id="enhCurrentLevel">+0</strong></div>
    <div class="stat-box"><small>ì†Œëª¨ íë¸Œ</small><strong id="enhTotalCubes">0 ê°œ</strong></div> 
    <div class="stat-box"><small>ì¥ë¹„ íŒŒê´´</small><strong id="enhDestroyedCount">0 ê°œ</strong></div>
    <div class="stat-box"><small>ì†Œëª¨ ìŠ¤í†¤</small><strong id="enhTotalCost">0 S</strong></div>
  </div>
  <div style="margin-top:15px;" id="enhancementButtons">
    <button id="enhSim1">ğŸ§Š ê°•í™”í•˜ê¸°</button>
    <button id="enhSimUntilMax">ğŸ”¥ +10ê°• ë„ì „</button>
    <button id="enhReset">ğŸ§¹ ì´ˆê¸°í™”</button>
  </div>
  <div id="enhancementRates" style="margin-top:0px; font-weight:700; font-size: 14px;">
    ì‹œë„ í™•ë¥ 
  </div>
  <div id="enhancementLog" style="display:none;">
    <b>ğŸ¹ ê°•í™” ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>
  </div>
</div>

<div id="expTab" class="tab-content">
  <div class="wrapper">
    <div class="card"> <h2>ğŸ“˜ ê²½í—˜ì¹˜ ê³„ì‚°ê¸°</h2>
      <div class="input-grid">
        <div class="row"><label for="currentLevel">í˜„ì¬ ë ˆë²¨</label><input id="currentLevel" type="number" placeholder="ì˜ˆ: 120" /></div>
        <div class="row"><label for="targetLevel">ëª©í‘œ ë ˆë²¨</label><input id="targetLevel" type="number" placeholder="ì˜ˆ: 140" /></div>
        <div class="row"><label for="currentPercent">í˜„ì¬ ê²½í—˜ì¹˜(%)</label><input id="currentPercent" type="number" placeholder="ì˜ˆ: 20" /></div>
        <div class="row"><label for="xpPerHour">ì‹œê°„ë‹¹ ê²½í—˜ì¹˜</label><input id="xpPerHour" type="number" placeholder="ì˜ˆ: 1,200,000"  /></div>
      </div>
      <div class="row buttons">
        <button id="run">ê³„ì‚°</button>
        <button id="reset">ì´ˆê¸°í™”</button>
      </div>
      <div class="results" id="results" hidden>
        <div class="stat"><small>ë‚¨ì€ ê²½í—˜ì¹˜</small><strong id="statRemain">-</strong></div>
        <div class="stat"><small>ì˜ˆìƒ ì†Œìš” ì‹œê°„ (ì¼)</small><strong id="statTimeAndDays">-</strong></div>
      </div>
    </div>
    <div class="card">
      <h2>â˜ ï¸ ì†Œìˆ˜ì  / ë§¹ë… ê³„ì‚°ê¸°</h2>
      <div class="search-group">
        <input id="poisonPetName" placeholder="ğŸ” í˜íŠ¸ë¥¼ ì…ë ¥í•´ ì£¼ì„¸ìš”." />
        <button id="btnPoisonSearch">ê²€ìƒ‰</button>
      </div>
      <div id="poisonResult" class="result" style="display:none;"></div>
    </div>
  </div>
</div>

<div id="pointTab" class="tab-content">
    <div id="pointCalcRoot"></div>
</div>

<script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;
    const clone = _.clone;

    // [ìˆ˜ì •] ì½ê¸° ì „ìš© ì¸í’‹: ë†’ì´ 22px ê³ ì • ë° ë‹¤í¬ í…Œë§ˆ ë°˜ì˜
    function ReadOnlyInput({ id, value, highlight }) {
        return (
            <div className="flex items-center justify-center w-full">
                <input
                    // input-compact ì ìš© ë° h-[22px] ë“± ì¤‘ë³µ ìŠ¤íƒ€ì¼ ì œê±°
                    className="input-compact w-full text-center font-medium cursor-default text-[11px] leading-none"
                    type="number"
                    id={id}
                    value={value}
                    readOnly={true}
                    tabIndex="-1"
                />
            </div>
        );
    }

    // [ìˆ˜ì •] í¸ì§‘ ê°€ëŠ¥ ì¸í’‹: ë†’ì´ 22px ê³ ì • ë° ë‹¤í¬ í…Œë§ˆ ë°˜ì˜
    function EditableInput({ value, leftValue, readOnly = false, onUpdate, tabIndex }) {
        const displayValue = value === 0 ? "" : value.toString();
        
        return (
            <div className="flex items-center justify-center w-full">
                <input
                    className={`input-compact w-full h-[22px] text-center font-semibold rounded text-[11px] leading-none placeholder:text-slate-500 ${
                        readOnly 
                        ? "cursor-not-allowed" 
                        : "bg-white"
                    }`}
                    type="text"
                    value={displayValue}
                    readOnly={readOnly}
                    tabIndex={tabIndex}
                    onChange={t => {
                        let rawInput = t.target.value;
                        if (rawInput === "") {
                            onUpdate && onUpdate(0);
                            return;
                        }
                        let numericValue = Number(rawInput);
                        if (!Number.isNaN(numericValue) && onUpdate) {
                            onUpdate(numericValue);
                        }
                    }}
                    onFocus={(e) => {
                         if (value === 0) e.target.select();
                    }}
                />
            </div>
        );
    }

    function renderReadOnlyRow(t, e, highlightStartIdx = -1) {
        return e.slice(0, 5).map((val, idx) => (
            <td key={`${t}-${idx}`} className="p-[1px] align-middle">
                <ReadOnlyInput id={`${t}${idx}`} value={val} highlight={idx >= highlightStartIdx && highlightStartIdx !== -1} />
            </td>
        ));
    }
    
    function renderEditableRow({ idPrefix, values, handler, isIntValue = false, leftValues, tabOffset }) {
        return values.slice(0, 5).map((val, idx) => {
            const computedTabIndex = tabOffset ? (idx + 1) * 20 + tabOffset : undefined;
            return (
                <td key={`${idPrefix}-${idx}`} className="p-[1px] align-middle">
                    {leftValues ? (
                        <EditableInput
                            value={isIntValue ? Math.trunc(val) : val}
                            leftValue={leftValues[idx]}
                            onUpdate={newVal => handler(idx, newVal)}
                            tabIndex={computedTabIndex}
                        />
                    ) : (
                        <EditableInput
                            value={isIntValue ? Math.trunc(val) : val}
                            onUpdate={newVal => handler(idx, newVal)}
                            tabIndex={computedTabIndex}
                        />
                    )}
                </td>
            );
        });
    }

    // ê³„ì‚° ë¡œì§
    const u = (t, e, s, n) => Math.trunc(n / 12 + s / 4 + (t - 85 * e) / 4);
    const h = (t, e) => {
        if (e < 0) return t;
        let s = 10 ** (e - 1);
        return t * s + 0.5 / s;
    };
    function k(t, e, s) {
        if (e === 0) return 0;
        return Math.trunc(100 * h(t / e * s, 1)) / 100 || 0;
    }
    function P(t, e, s, n) {
        return Math.trunc((Math.trunc(t) + Math.trunc(e) + Math.trunc(s) + Math.trunc(n)) * 100) / 100;
    }

    function Calculator({ data: initialData, onSave, onLoad, onPresetLoad }) {
        const [c0, setC0] = useState(initialData.initStats[0]); 
        const [j, m] = useState(initialData.levels);
        const [v, f] = useState({ vits: initialData.stats.vits, strs: initialData.stats.strs, tghs: initialData.stats.tghs, dexs: initialData.stats.dexs });
        const [b, g] = useState(initialData.extraStats);
        const [N, p] = useState(initialData.questSum);

        useEffect(() => {
            setC0(initialData.initStats[0]);
            m(initialData.levels);
            f({ vits: initialData.stats.vits, strs: initialData.stats.strs, tghs: initialData.stats.tghs, dexs: initialData.stats.dexs });
            g(initialData.extraStats);
            p(initialData.questSum);
        }, [initialData]);

        const S = v.vits.map((t, e) => t + v.strs[e] + v.tghs[e] + v.dexs[e]);
        const y = v.vits.map((t, e) => Math.trunc(t) + Math.trunc(v.strs[e]) + Math.trunc(v.tghs[e]) + Math.trunc(v.dexs[e]));

        const w = S.map((t, e) => {
            if (0 === t) return 0;
            const cumulativeLevel = j.slice(0, e + 1).reduce((acc, curr) => acc + curr, 0);
            return u(cumulativeLevel, e + 1, N[e], t);
        });

        const C = {
            vits: v.vits.map((t, e) => k(t, S[e], w[e])),
            strs: v.strs.map((t, e) => k(t, S[e], w[e])),
            tghs: v.tghs.map((t, e) => k(t, S[e], w[e])),
            dexs: v.dexs.map((t, e) => k(t, S[e], w[e])),
        };

        // [ìˆ˜ì •] ì¤‘ìš”: ì´ì „ í™˜ìƒì˜ ê²°ê³¼ê°’ì´ ë³€ê²½ë˜ë©´, ìë™ìœ¼ë¡œ ë‹¤ìŒ í™˜ìƒ ì…ë ¥ê°’ì— ì†Œìˆ˜ì ì„ ë°˜ì˜í•˜ëŠ” ë¡œì§
        useEffect(() => {
            // í˜„ì¬ ìƒíƒœ ë³µì œ (vits, strs ë“± ë°°ì—´ì„ ìƒˆë¡œ ìƒì„±í•˜ì—¬ ë¶ˆë³€ì„± ìœ ì§€)
            const newStats = {
                vits: [...v.vits],
                strs: [...v.strs],
                tghs: [...v.tghs],
                dexs: [...v.dexs]
            };
            let hasChanges = false;

            // 2í™˜ìƒ(idx 1)ë¶€í„° 5í™˜ìƒ(idx 4)ê¹Œì§€ ìˆœíšŒ
            for (let i = 1; i < 5; i++) {
                ['vits', 'strs', 'tghs', 'dexs'].forEach(statKey => {
                    // ì´ì „ ë‹¨ê³„ì˜ ê³„ì‚° ê²°ê³¼ (CëŠ” ë Œë”ë§ ì¤‘ ê³„ì‚°ë¨)
                    const prevResult = C[statKey][i - 1];
                    // ì†Œìˆ˜ì  ì¶”ì¶œ (ì˜ˆ: 61.5 -> 0.5)
                    const decimalPart = prevResult ? prevResult - Math.floor(prevResult) : 0;
                    
                    // í˜„ì¬ ì €ì¥ëœ ìŠ¤íƒ¯ ê°’
                    const currentVal = newStats[statKey][i];
                    // ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì •ìˆ˜ë¶€ë¼ê³  ê°€ì • (Math.floor)
                    const currentInt = Math.floor(currentVal);
                    
                    // ì˜¬ë°”ë¥¸ ê°’ = ì •ìˆ˜ë¶€ + ì´ì „ ë‹¨ê³„ ì†Œìˆ˜ì 
                    const correctVal = currentInt + decimalPart;

                    // í˜„ì¬ ê°’ê³¼ ê³„ì‚°ëœ ê°’ì´ ë‹¤ë¥´ë©´ (ë¶€ë™ì†Œìˆ˜ì  ì˜¤ì°¨ ê³ ë ¤) ì—…ë°ì´íŠ¸
                    if (Math.abs(currentVal - correctVal) > 0.00001) {
                        newStats[statKey][i] = correctVal;
                        hasChanges = true;
                    }
                });
            }

            // ë³€ê²½ì‚¬í•­ì´ ìˆë‹¤ë©´ ìƒíƒœ ì—…ë°ì´íŠ¸
            if (hasChanges) {
                f(newStats);
            }
        }, [v, j, N, b]); // Cë¥¼ êµ¬ì„±í•˜ëŠ” ì˜ì¡´ì„±ë“¤ì´ ë³€í•  ë•Œ ì‹¤í–‰

        const V = C.vits.map((t, e) => {
            const baseRebirthPoint = P(C.vits[e], C.strs[e], C.tghs[e], C.dexs[e]);
            return baseRebirthPoint + b[e];
        });

        const fullTotals = C.vits.map((t, e) => {
            const rawSum = t + C.strs[e] + C.tghs[e] + C.dexs[e] + b[e];
            return Math.round(rawSum * 100) / 100;
        });

        const derivedInitStats = [c0, V[0], V[1], V[2], V[3]];

        const M = derivedInitStats.map((t, e) => {
            let n = j[e];
            let r = y[e];
            return 0 === n ? 0 : Math.trunc(t) + 3 * (n - 1) - r;
        });

        const handleInitStatChange = (val) => { setC0(val); };
        const E = (t, e) => { let s = clone(j); s[t] = Math.trunc(e); m(s); };
        function O(t, e, s) {
            let n = clone(v);
            let r = C[t][e - 1]; 
            if (r) n[t][e] = r - Math.floor(r) + Number(s);
            else n[t][e] = Number(s);
            f(n);
        }
        
        const handleSaveWrapper = useCallback(() => {
            const dataToSave = {
                levels: j,
                initStats: [c0, 0, 0, 0, 0], // ì €ì¥ ì‹œì—ëŠ” 1í™˜ìƒ ì´ˆê¸°ìŠ¤íƒ¯ë§Œ ì €ì¥
                stats: v,
                extraStats: b,
                questSum: N
            };
            onSave(dataToSave);
        }, [j, c0, v, b, N, onSave]);

        const handleReset = useCallback(() => {
            if (window.confirm("ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                setC0(20); // ì´ˆê¸° ìŠ¤íƒ¯ ê¸°ë³¸ê°’
                m([0, 0, 0, 0, 0]); // ë ˆë²¨
                f({ // ì£¼ìš” ìŠ¤íƒ¯
                    vits: [0, 0, 0, 0, 0],
                    strs: [0, 0, 0, 0, 0],
                    tghs: [0, 0, 0, 0, 0],
                    dexs: [0, 0, 0, 0, 0]
                });
                g([10, 20, 30, 40, 50]);
                p([20, 40, 60, 80, 100]);
            };
        }, []);

        // [ìˆ˜ì •] ë‚¨ì€ ìŠ¤íƒ¯ í–‰ (Dark Theme)
        const renderLeftStatRow = (t, e) => {
            return e.slice(0, 5).map((val, idx) => {
                const isZeroLevel = j[idx] === 0;
                let styleClass = "";

                if (isZeroLevel) {
                    // ë ˆë²¨ 0
                    styleClass = "!bg-slate-900 !text-slate-400 !border-slate-700";
                } else if (val < 0) {
                    // ë§ˆì´ë„ˆìŠ¤ (ìŠ¤íƒ¯ ì´ˆê³¼): ì§„í•œ ë¹¨ê°•
                    styleClass = "!bg-red-900 !text-red-200 !border-red-500"; 
                } else if (val > 0) {
                    // í”ŒëŸ¬ìŠ¤ (ìŠ¤íƒ¯ ë‚¨ìŒ): ì§„í•œ ì£¼í™©
                    styleClass = "!bg-orange-900 !text-orange-200 !border-orange-500";
                } else {
                    // 0 (ë”± ë§ìŒ)
                    styleClass = "!bg-slate-900 !text-slate-400 !border-slate-700";
                }

                return (
                    <td key={`${t}-${idx}`} className="p-[1px] align-middle">
                        <div className="flex items-center justify-center w-full">
                            <input 
                                className={`input-compact w-full text-center text-[11px] cursor-default border ${styleClass}`} 
                                type="number" 
                                value={val} 
                                readOnly={true} 
                            />
                        </div>
                    </td>
                );
            });
        };

        // [ìˆ˜ì •] ì´ˆê¸° ìŠ¤íƒ¯ í–‰ (Dark Theme)
        const renderInitStatRow = () => {
            const highlightClasses = "font-bold text-yellow-300 bg-slate-800 border-yellow-500"; // New highlight
            return derivedInitStats.map((val, idx) => {
                if (idx === 0) {
                    // 1í™˜ìƒ ì´ˆê¸°ìŠ¤íƒ¯(ì…ë ¥ ê°€ëŠ¥ ì¹¸)ì€ EditableInput ì‚¬ìš© (ì´ë¯¸ ì§ì‚¬ê°í˜• í†µì¼)
                    return (<td key={`init-${idx}`} className="p-[1px] align-middle"><EditableInput value={val} onUpdate={handleInitStatChange} readOnly={true} tabIndex={0}/></td>); 
                }
                return (
                    <td key={`init-${idx}`} className="p-[1px] align-middle">
                            <div className="relative flex items-center justify-center group w-full">
                            {idx > 0 && (<div className="absolute -left-1 text-yellow-600 text-[8px] z-10">â–¶</div>)}
                            {/* input-compact ì ìš© ë° í†µì¼ */}
                            <input className={`input-compact w-full text-center cursor-default text-[11px] ${highlightClasses}`} type="number" value={val} readOnly={true} />
                        </div>
                    </td>
                );
            });
        };

        // [ìˆ˜ì •] í—¤ë” ìŠ¤íƒ€ì¼ (Dark Theme)
        const headerStyles = [
            "bg-yellow-800 text-yellow-300 border-yellow-700", 
            "bg-green-800 text-green-300 border-green-700", 
            "bg-sky-800 text-sky-300 border-sky-700", 
            "bg-rose-800 text-rose-300 border-rose-700", 
            "bg-purple-800 text-purple-300 border-purple-700"
        ];
        
        // [ìˆ˜ì •] ë¼ë²¨ ì—´ ë„ˆë¹„ 70pxë¡œ ë³€ê²½ ë° ë‹¤í¬ í…Œë§ˆ ì ìš©
        const RowHeader = ({ label }) => (
            <td className="text-center py-0 px-1.5 whitespace-nowrap text-[10px] font-semibold text-ffd447 bg-slate-700 border-r border-slate-600 w-[70px] align-middle h-[24px]">
                {label}
            </td>
        );

        return (
            <div className="select-none">
                <h2 className="text-xl mt-0 font-bold text-ffd447 text-center mb-1">ğŸ”„ í™˜ìƒ í¬ì¸íŠ¸ ê³„ì‚°ê¸°</h2>
                <div className="bg-transparent rounded-lg shadow overflow-hidden">
                    <div className="bg-slate-900/70">
                        {/* table-fixed ì‚¬ìš© ë° w-full (í•˜ì§€ë§Œ ë¶€ëª¨ê°€ 540pxì´ë¯€ë¡œ 540pxë¡œ ê³ ì •ë¨) */}
                        <table className="w-full border-collapse table-fixed">
                            {/* [ìˆ˜ì •] í…Œì´ë¸” í—¤ë“œ (Dark Theme & Text Update) */}
                            <thead>
                                <tr className="bg-slate-800 border-b border-slate-700 text-[10px]">
                                    <th className="py-1 px-1 border-r border-slate-700 w-[70px]">í™˜ìƒ ë‹¨ê³„</th>
                                    {["1í™˜ìƒ", "2í™˜ìƒ", "3í™˜ìƒ", "4í™˜ìƒ", "5í™˜ìƒ"].map((text, i) => (
                                        <th key={i} className="py-1 px-0 h-[24px] align-middle">
                                            <span className={`inline-block px-1.5 py-0.5 rounded text-[9px] font-bold border ${headerStyles[i]}`}>{text}</span>
                                        </th>
                                    ))}
                                </tr>
                            </thead>
                            {/* [ìˆ˜ì •] í…Œì´ë¸” ë°”ë”” (Dark Theme & Label Update) */}
                            <tbody className="divide-y divide-slate-800 text-[10px] bg-slate-900">
                                <tr><RowHeader label="ì´ˆê¸° ìŠ¤íƒ¯" />{renderInitStatRow()}</tr>
                                <tr><RowHeader label="ë ˆë²¨" />{renderEditableRow({ idPrefix: "level", values: j, handler: E, tabOffset: 1 })}</tr>
                                <tr><RowHeader label="ì²´ë ¥" />{renderEditableRow({ idPrefix: "vit", values: v.vits, handler: (t, e) => O("vits", t, e), isIntValue: !0, leftValues: M, tabOffset: 2 })}</tr>
                                <tr><RowHeader label="ì™„ë ¥" />{renderEditableRow({ idPrefix: "str", values: v.strs, handler: (t, e) => O("strs", t, e), isIntValue: !0, leftValues: M, tabOffset: 3 })}</tr>
                                <tr><RowHeader label="ê±´ê°•" />{renderEditableRow({ idPrefix: "tgh", values: v.tghs, handler: (t, e) => O("tghs", t, e), isIntValue: !0, leftValues: M, tabOffset: 4 })}</tr>
                                <tr><RowHeader label="ìˆœë°œ" />{renderEditableRow({ idPrefix: "dex", values: v.dexs, handler: (t, e) => O("dexs", t, e), isIntValue: !0, leftValues: M, tabOffset: 5 })}</tr>
                                <tr className="bg-slate-800/50"><RowHeader label="ë‚¨ì€ ìŠ¤íƒ¯" />{renderLeftStatRow("leftStat", M)}</tr>
                                <tr><RowHeader label="ì´ ìŠ¤íƒ¯" />{renderReadOnlyRow("intTotalStat", y)}</tr>
                                {/* ê²°ê³¼ ì„¹ì…˜ êµ¬ë¶„ì */}
                                <tr className="bg-slate-800"><td colSpan="6" className="py-0.5 text-[11px] font-bold text-ffd447 text-center border-y border-slate-700 h-[20px] align-middle">ê²°ê³¼ëŠ” ìë™ìœ¼ë¡œ ê³„ì‚°ë©ë‹ˆë‹¤.</td></tr>
                                
                                <tr className="border-t border-slate-700">
                                    <RowHeader label="í™˜í¬í€˜(ëˆ„ì )" />
                                    {[10, 20, 30, 40, 50].map((value, idx) => (
                                        <td key={`questFixed-${idx}`} className="p-[1px] align-middle">
                                            <ReadOnlyInput value={value} />
                                        </td>
                                    ))}
                                </tr>
                                <tr><RowHeader label="ë³´ë„ˆìŠ¤ ìŠ¤íƒ¯" />{renderReadOnlyRow("extraStat", b)}</tr>
                                <tr><RowHeader label="ê³„ì‚°ì‹" />{renderReadOnlyRow("transPoint", w)}</tr>
                                <tr><RowHeader label="ì²´ë ¥" />{renderReadOnlyRow("afterStat-vits", C.vits)}</tr>
                                <tr><RowHeader label="ì™„ë ¥" />{renderReadOnlyRow("afterStat-strs", C.strs)}</tr>
                                <tr><RowHeader label="ê±´ê°•" />{renderReadOnlyRow("afterStat-tghs", C.tghs)}</tr>
                                <tr><RowHeader label="ìˆœë°œ" />{renderReadOnlyRow("afterStat-dexs", C.dexs)}</tr>
                                {/* ì´ í™˜í¬ í–‰ (í•˜ì´ë¼ì´íŠ¸) */}
                                <tr className="total-input-highlight font-bold border-t border-slate-700">
                                    <RowHeader label="ì´ í™˜í¬" />
                                    {V.slice(0, 5).map((val, idx) => (
                                        <td key={`total-${idx}`} className="p-[1px] align-middle">
                                            <div className="flex flex-col items-center justify-center w-full py-0.5">
                                                {/* input-compact ì ìš© ë° í†µì¼ */}
                                                <input className="input-compact w-full text-center font-bold cursor-default text-[11px] leading-none" type="number" value={val} readOnly={true} />
                                                {/* ì•„ë˜ì˜ ì†Œìˆ˜ì  ê°’ í‘œì‹œëŠ” ê²€ì€ìƒ‰ ë°°ê²½ì— ë§ê²Œ ìƒ‰ìƒ ìˆ˜ì • */}
                                                <span className="text-[9px] text-slate-400 leading-none mt-0.5">({fullTotals[idx]})</span>
                                            </div>
                                        </td>
                                    ))}
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    {/* [ìˆ˜ì •] ë²„íŠ¼ ì˜ì—­ (Dark Theme) */}
                    <div className="bg-slate-700 p-2 border-t border-slate-600 flex items-center justify-center gap-2">
                        <button className="px-3 py-1 bg-rose-600 border border-rose-500 rounded shadow-sm text-[10px] text-white hover:bg-rose-700" onClick={handleReset}>ì´ˆê¸°í™”</button>
                        <button className="px-3 py-1 bg-slate-600 border border-slate-500 rounded shadow-sm text-[10px] text-white hover:bg-slate-700" onClick={() => onLoad()}>ë¶ˆëŸ¬ì˜¤ê¸°</button>
                        <button className="px-3 py-1 bg-blue-600 border border-blue-500 rounded shadow-sm text-[10px] text-white hover:bg-blue-700" onClick={() => handleSaveWrapper()}>ì €ì¥í•˜ê¸°</button>
                        <button className="px-3 py-1 bg-purple-600 border border-purple-500 rounded shadow-sm text-[10px] text-white hover:bg-purple-700" onClick={() => onPresetLoad('perfectStr')}>193 ì™„ìº</button>
                        <button className="px-3 py-1 bg-teal-600 border border-teal-500 rounded shadow-sm text-[10px] text-white hover:bg-teal-700" onClick={() => onPresetLoad('perfectAgi')}>193 ìˆœìº</button>
                    </div>
                </div>
            </div>
        );
    }

    function App() {
        const defaultData = {
            levels: [0, 0, 0, 0, 0],
            initStats: [20, 0, 0, 0, 0],
            stats: { vits: [0, 0, 0, 0, 0], strs: [0, 0, 0, 0, 0], tghs: [0, 0, 0, 0, 0], dexs: [0, 0, 0, 0, 0] },
            extraStats: [10, 20, 30, 40, 50],
            questSum: [20, 40, 60, 80, 100]
        };
        const storageKey = "transCalculatorData";
        const [data, setData] = useState(defaultData);
        
        // --- í”„ë¦¬ì…‹ ë°ì´í„° ì •ì˜ ---
        const presets = useMemo(() => ({
            perfectStr: { // 193 ì™„ìº
                levels: [140, 140, 140, 140, 140],
                initStats: [20, 0, 0, 0, 0], 
                stats: {
                    vits: [0, 3.5, 13.05, 0, 2.5],
                    strs: [437, 473.5, 476.82, 547.98, 573.5],
                    tghs: [0, 3.5, 13.05, 0, 2.5],
                    dexs: [0, 3.5, 13.05, 0, 0.5]
                },
                extraStats: [10, 20, 30, 40, 50],
                questSum: [20, 40, 60, 80, 100]
            },
            perfectAgi: { // 193 ìˆœìº
                levels: [140, 140, 140, 140, 140],
                initStats: [20, 0, 0, 0, 0], 
                stats: {
                    vits: [87, 127.44, 54.769999999999996, 0, 124.5],
                    strs: [0, 3.5, 13.05, 0, 0.5],
                    tghs: [0, 3.5, 13.05, 0, 2.5],
                    dexs: [350, 349.55, 435.11, 547.98, 451.5]
                },
                extraStats: [10, 20, 30, 40, 50],
                questSum: [20, 40, 60, 80, 100]
            }
        }), []);
        // -----------------------------

        const handleSave = useCallback((t) => {
            if (!window.localStorage.getItem(storageKey) || window.confirm("ë®ì–´ì”Œìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                window.localStorage.setItem(storageKey, JSON.stringify(t));
                alert("ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.");
            }
        }, []);

        const handleLoad = useCallback(() => {
            let t = window.localStorage.getItem(storageKey);
            if (!t) { alert("ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤."); return; }
            setData(JSON.parse(t));
            alert("ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤.");
        }, []);
        
        // --- í”„ë¦¬ì…‹ ë¡œë“œ í•¸ë“¤ëŸ¬ ì¶”ê°€ ---
        const handlePresetLoad = useCallback((presetName) => {
            const preset = presets[presetName];
            if (preset) {
                if (window.confirm(`${presetName === 'perfectStr' ? '193 ì™„ìº' : '193 ìˆœìº'} í”„ë¦¬ì…‹ì„ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\n(í˜„ì¬ ë°ì´í„°ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.)`)) {
                    setData(_.cloneDeep(preset));
                }
            } else {
                alert("í”„ë¦¬ì…‹ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
            }
        }, [presets]);
        // -----------------------------

        return <Calculator data={data} onSave={handleSave} onLoad={handleLoad} onPresetLoad={handlePresetLoad} />; // onPresetLoad ì „ë‹¬
    }

    const root = ReactDOM.createRoot(document.getElementById('pointCalcRoot'));
    root.render(<App />);
</script>

<script>
Decimal.set({ precision:50, rounding: Decimal.ROUND_DOWN });

function cutDecimal(num, places) {
  let decimal = new Decimal(num).toDP(places, Decimal.ROUND_DOWN);
  return decimal.toString();
}
  
function computeS0RealFromKU(k, u) {
  const fac = k / 100;
  const hpB  = (u.hp + 4.5) * fac;
  const atkB = (u.atk + 4.5) * fac;
  const defB = (u.def + 4.5) * fac;
  const agiB = (u.agi + 4.5) * fac;
  const hp  = hpB * 4 + atkB + defB + agiB;
  const atk = hpB * 0.1 + atkB + defB * 0.1 + agiB * 0.05;
  const def = hpB * 0.1 + atkB * 0.1 + defB + agiB * 0.05;
  const agi = agiB;
  return { hp, atk, def, agi };
}

function getAverageEValueFromU(u) {
  const sumU = u.hp + u.atk + u.def + u.agi;
  let minE, maxE; 
  if (sumU >= 110) { minE = 410; maxE = 460; } 
  else if (sumU >= 105) { minE = 430; maxE = 480; } 
  else if (sumU >= 100) { minE = 450; maxE = 500; } 
  else if (sumU >= 95) { minE = 470; maxE = 520; } 
  else if (sumU >= 90) { minE = 490; maxE = 540; } 
  else if (sumU >= 85) { minE = 510; maxE = 560; } 
  else if (sumU >= 80) { minE = 530; maxE = 580; } 
  else { minE = 550; maxE = 600; }
  const avgE = (minE + maxE) / 2;
  return { e: avgE }; 
}

function computeSGRealFromE(u, e_value) {
  const fac = e_value / 10000;
  const uHp  = u.hp + 4.5;
  const uAtk = u.atk + 4.5;
  const uDef = u.def + 4.5;
  const uAgi = u.agi + 4.5;
  const hp  = fac * (uHp * 4 + uAtk + uDef + uAgi);
  const atk = fac * (uHp * 0.1 + uAtk + uDef * 0.1 + uAgi * 0.05);
  const def = fac * (uHp * 0.1 + uAtk * 0.1 + uDef + uAgi * 0.05);
  const agi = fac * uAgi;
  return { hp, atk, def, agi };
}

document.addEventListener("DOMContentLoaded", () => {
  /* íƒ­ ì „í™˜ ë¡œì§ ìˆ˜ì •: pointTab ì¶”ê°€ */
  const showTab = id => {
    document.querySelectorAll(".tab-content").forEach(t=>t.classList.remove("active"));
    document.querySelectorAll(".tab-buttons button").forEach(b=>b.classList.remove("active"));
    document.getElementById(id).classList.add("active");
    
    let btnId = "tabSim";
    if (id === "enhTab") btnId = "tabEnh";
    else if (id === "expTab") btnId = "tabExp";
    else if (id === "pointTab") btnId = "tabPoint";
    
    document.getElementById(btnId).classList.add("active"); 
  };
  
  document.getElementById("tabSim").onclick=()=>showTab("simTab");
  document.getElementById("tabEnh").onclick=()=>showTab("enhTab"); 
  document.getElementById("tabExp").onclick=()=>showTab("expTab");
  document.getElementById("tabPoint").onclick=()=>showTab("pointTab"); // ì¶”ê°€ë¨
  showTab("simTab");

  /* ê°•í™” ì‹œë®¬ë ˆì´í„° ë¡œì§ */
  const ENH_STATS = [
    { level: +1, success: 1.00, destroy: 0.00, cost: 35000 },
    { level: +2, success: 0.80, destroy: 0.00, cost: 59800 },
    { level: +3, success: 0.60, destroy: 0.00, cost: 106400 },
    { level: +4, success: 0.50, destroy: 0.00, cost: 152710 },
    { level: +5, success: 0.40, destroy: 0.60, cost: 273600 },
    { level: +6, success: 0.40, destroy: 0.60, cost: 468530 },
    { level: +7, success: 0.30, destroy: 0.70, cost: 552800 },
    { level: +8, success: 0.20, destroy: 0.80, cost: 698470 },
    { level: +9, success: 0.20, destroy: 0.80, cost: 857200 },
    { level: +10, success: 0.10, destroy: 0.90, cost: 1195390 },
  ];
  
  const CUBE_DATA = {
    'NORMAL_CUBE': { name: 'ì¼ë°˜ íë¸Œ', rate_increase: 0, cost_multiplier: 1.0 },
    'ADVANCED_CUBE': { name: 'ê³ ê¸‰ íë¸Œ', rate_increase: 5, cost_multiplier: 2.0 },
  };

  const AID_DATA = {
    'NONE': { name: 'ì‚¬ìš© ì•ˆ í•¨', rate_increase: 0 },
    'AID_5': { name: 'ê°•í™” ë³´ì¡°ì œ (+5%)', rate_increase: 5 },
    'AID_10': { name: 'ê°•í™” ë³´ì¡°ì œ (+10%)', rate_increase: 10 },
    'AID_15': { name: 'ê°•í™” ë³´ì¡°ì œ (+15%)', rate_increase: 15 },
    'AID_20': { name: 'ê°•í™” ë³´ì¡°ì œ (+20%)', rate_increase: 20 },
  };

  let isMaxSimulationRunning = false; 
  let currentEnhLevel = 0;
  let totalEnhCost = 0;
  let totalCubes = 0; 
  let destroyedCount = 0;
  let enhancementLogEntries = []; 

  const enhCurrentLevelDisplay = document.getElementById("enhCurrentLevel");
  const enhTotalCubesDisplay = document.getElementById("enhTotalCubes"); 
  const enhDestroyedCountDisplay = document.getElementById("enhDestroyedCount");
  const enhTotalCostDisplay = document.getElementById("enhTotalCost");
  const enhLog = document.getElementById("enhancementLog");
  const initialEnhancementLevelInput = document.getElementById("initialEnhancementLevel"); 
  const cubeSelect = document.getElementById("enhancementCube");
  const aidSelect = document.getElementById("enhancementAid");
  const enhancementRatesDisplay = document.getElementById("enhancementRates");
  
  const fmt = n => n.toLocaleString('ko-KR');

  function updateEnhancementRatesDisplay(level) {
      if (level >= 10) {
          enhancementRatesDisplay.textContent = "";
          return;
      }
      const nextLevel = level + 1;
      const dataIndex = nextLevel - 1;
      const enhData = ENH_STATS[dataIndex];
      const selectedCube = CUBE_DATA[cubeSelect.value];
      const selectedAid = AID_DATA[aidSelect.value];
      
      let baseSuccessRate = enhData.success * 100; 
      const cubeBonus = selectedCube.rate_increase;
      const aidBonus = selectedAid.rate_increase;
      let finalSuccessRate = baseSuccessRate + cubeBonus + aidBonus;
      if (baseSuccessRate === 100) finalSuccessRate = 100;
      else if (finalSuccessRate > 100) finalSuccessRate = 100;          
      
      const successRate = finalSuccessRate.toFixed(0);
      const failRate = (100 - finalSuccessRate).toFixed(0);
      const failType = nextLevel >= 5 ? "íŒŒê´´" : "ìœ ì§€";
      
      enhancementRatesDisplay.innerHTML = `[+${level} â†’ +${nextLevel}] <span style="color:#00ffff;">ì„±ê³µ: ${successRate}%  <span style="color:#ff6b81;">ì‹¤íŒ¨(${failType}): ${failRate}%`;
  }

  function updateEnhLogDisplay() {
    let logHtml = `<b>ğŸ¹ ê°•í™” ì‹œë®¬ë ˆì´ì…˜ ë¡œê·¸</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>`;
    const maxLogs = 100; 
    const startIndex = enhancementLogEntries.length > maxLogs ? enhancementLogEntries.length - maxLogs : 0;
    for (let i = startIndex; i < enhancementLogEntries.length; i++) logHtml += enhancementLogEntries[i];
    enhLog.innerHTML = logHtml;
    enhLog.scrollTop = enhLog.scrollHeight;
  }
  
  function updateEnhUI() {
    enhCurrentLevelDisplay.textContent = `+${currentEnhLevel}`;
    enhTotalCostDisplay.textContent = `${fmt(totalEnhCost)} S`;
    enhTotalCubesDisplay.textContent = `${fmt(totalCubes)} ê°œ`; 
    enhDestroyedCountDisplay.textContent = `${fmt(destroyedCount)} ê°œ`;
    updateEnhancementRatesDisplay(currentEnhLevel);
  }
  
  function resetEnhancement(initialLevel = 0) {
    if (initialLevel < 0) initialLevel = 0;
    if (initialLevel > 9) initialLevel = 9; 
    currentEnhLevel = initialLevel;
    totalEnhCost = 0;
    totalCubes = 0; 
    destroyedCount = 0;
    isMaxSimulationRunning = false; 
    enhancementLogEntries = []; 
    if (initialLevel > 0) {
        enhancementLogEntries.push(`+${initialLevel} ìƒíƒœë¡œ ì‹œì‘<br>`);
    }
    enhLog.style.display = "none";
    updateEnhLogDisplay();
    updateEnhUI();
  }
  
  resetEnhancement(parseInt(initialEnhancementLevelInput.value) || 0); 

  function enhance(simulateUntilMax = false) {
    if (currentEnhLevel >= 10) {
        if (!simulateUntilMax) alert("+10 ê°•í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”.");
        return;
    }
    enhLog.style.display = "inline-block";
    isMaxSimulationRunning = simulateUntilMax;
    
    const selectedCube = CUBE_DATA[cubeSelect.value];
    const selectedAid = AID_DATA[aidSelect.value];
    const initialLevelFromInput = parseInt(initialEnhancementLevelInput.value) || 0; 

    const runEnhancementStep = (level, targetLevel) => {
        const CHUNK_SIZE = isMaxSimulationRunning ? 500 : 1; 
        let attempts = 0;
        while (level < targetLevel && attempts < CHUNK_SIZE) {
            const nextLevel = level + 1;
            const dataIndex = nextLevel - 1; 
            const enhData = ENH_STATS[dataIndex];
            if (!enhData) break; 
            
            let baseSuccessRate = enhData.success * 100; 
            const cubeBonus = selectedCube.rate_increase;
            const aidBonus = selectedAid.rate_increase;
            let finalSuccessRate = baseSuccessRate + cubeBonus + aidBonus;
            if (baseSuccessRate === 100) finalSuccessRate = 100;
            else if (finalSuccessRate > 100) finalSuccessRate = 100;          

            const pSuccess = finalSuccessRate / 100.0; 
            const cost = Math.round(enhData.cost * selectedCube.cost_multiplier);
            
            totalEnhCost += cost;
            totalCubes += 1; 
            attempts++;

            const roll = Math.random();
            const logEntry = `[+${level} â†’ +${nextLevel}] (í™•ë¥  ${Math.round(finalSuccessRate)}%) : `;
            let newLog = "";
            
            if (roll < pSuccess) {
                level = nextLevel;
                if (!isMaxSimulationRunning) newLog = `${logEntry}<span class="enh-success">âœ… ì„±ê³µ! (+${nextLevel})</span> (ìŠ¤í†¤ ${fmt(cost)} S)<br>`;
            } else {
                const isDestructiveLevel = nextLevel >= 5; 
                if (isDestructiveLevel) {
                    level = initialLevelFromInput;
                    destroyedCount++;
                    if (!isMaxSimulationRunning) newLog = `${logEntry}<span class="enh-destroy">ğŸ’¥ íŒŒê´´!</span> (ìŠ¤í†¤ ${fmt(cost)} S)<br>`;
                } else {
                    if (!isMaxSimulationRunning) newLog = `${logEntry}<span class="enh-fail">âŒ ì‹¤íŒ¨!</span> (ìŠ¤í†¤ ${fmt(cost)} S)<br>`;
                }
            }
            if (newLog) enhancementLogEntries.push(newLog);
            if (level >= 10) break; 
        } 
        
        currentEnhLevel = level;
        updateEnhUI(); 
        updateEnhLogDisplay(); 
        
        if (simulateUntilMax && currentEnhLevel < 10) {
             setTimeout(() => runEnhancementStep(currentEnhLevel, 10), 0);
        } else if (currentEnhLevel >= 10) {
             isMaxSimulationRunning = false;
             if (simulateUntilMax) {
               enhancementLogEntries.push(`<b style="color: #3ba4f7;">ğŸ‰ +10 ê°•í™” ì„±ê³µ!</b> (íë¸Œ ${fmt(totalCubes)}ê°œ ì†Œëª¨)<br>`);
               updateEnhLogDisplay();
             }
        }
    };
    
    if (simulateUntilMax) runEnhancementStep(currentEnhLevel, 10); 
    else runEnhancementStep(currentEnhLevel, currentEnhLevel + 1); 
  }

  document.getElementById("enhSim1").onclick = () => enhance(false);
  document.getElementById("enhSimUntilMax").onclick = () => {
    if (currentEnhLevel >= 10) { alert("+10 ê°•í™”ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì´ˆê¸°í™” í›„ ë‹¤ì‹œ ì‹œì‘í•˜ì„¸ìš”."); return; }
    if (isMaxSimulationRunning) return;
    const initialLevel = parseInt(initialEnhancementLevelInput.value) || 0;
    resetEnhancement(initialLevel);
    enhance(true);
  };
  document.getElementById("enhReset").onclick = () => {
    const initialLevel = parseInt(initialEnhancementLevelInput.value) || 0;
    resetEnhancement(initialLevel);
  };
  initialEnhancementLevelInput.onchange = (e) => {
    const level = parseInt(e.target.value) || 0;
    resetEnhancement(level); 
  };
  cubeSelect.onchange = () => { updateEnhancementRatesDisplay(currentEnhLevel); }; 
  aidSelect.onchange = () => { updateEnhancementRatesDisplay(currentEnhLevel); }; 

  /* ì´ˆêµ¬ ì‹œë®¬ë ˆì´í„° ë¡œì§ */
  async function loadPetData(){
    const DATA_PATH = "data/pets.json"; 
    try{
      const pets = await fetch(DATA_PATH).then(r => {
        if (!r.ok) throw new Error(`HTTP Error: ${r.status}`);
        return r.json();
      }); 
      console.log("âœ… JSON ë¡œë“œ ì™„ë£Œ:", Object.keys(pets).length);
      return pets;
    }catch(e){
      console.error("âŒ JSON ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:",e);
      alert("í˜íŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.\npets.json íŒŒì¼ì„ '/data' í´ë”ì— ë°°ì¹˜í–ˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.");
      return {}; 
    }
  }

  let PETS = {}, currentBase = null;
  const sgradeBox=document.getElementById("sgrade");
  const nameInput=document.getElementById("petName");
  const resultBox=document.getElementById("result");
  const costDisplay=document.getElementById("costDisplay");
  let totalCost=0;
  let totalCostPerfect = 0;

  loadPetData().then(d => { 
      PETS = d; 
      const input = document.getElementById("poisonPetName");
      const btn = document.getElementById("btnPoisonSearch");
      const result = document.getElementById("poisonResult");

      input.onkeydown = (e) => { if(e.key === "Enter") btn.click(); };
      btn.onclick = () => {
        const name = input.value.trim();
        const p = PETS[name];
        if (!p || !p.k || !p.u) {
          result.style.display = "block";
          result.textContent = "âŒ í˜íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
          return;
        }
        const k = p.k;
        const u = p.u;
        const S0real = computeS0RealFromKU(k, u);
        const { e: avgE } = getAverageEValueFromU(u);
        const SGreal = computeSGRealFromE(u, avgE);

        let decimalResult = `
          <b>ğŸ“¢ ì´ˆê¸°ì¹˜ ìƒì„¸</b>
          <div class="decimal-grid">
            <span>ë‚´êµ¬ë ¥</span><span>${cutDecimal(S0real.hp, 8)}</span>
            <span>ê³µê²©ë ¥</span><span>${cutDecimal(S0real.atk, 8)}</span>
            <span>ë°©ì–´ë ¥</span><span>${cutDecimal(S0real.def, 8)}</span>
            <span>ìˆœë°œë ¥</span><span>${cutDecimal(S0real.agi, 8)}</span>
          </div>
          <b>ğŸ“¢ ì„±ì¥ë¥  ìƒì„¸</b>
          <div class="decimal-grid">
            <span>ë‚´êµ¬ë ¥</span><span>${cutDecimal(SGreal.hp, 8)}</span>
            <span>ê³µê²©ë ¥</span><span>${cutDecimal(SGreal.atk, 8)}</span>
            <span>ë°©ì–´ë ¥</span><span>${cutDecimal(SGreal.def, 8)}</span>
            <span>ìˆœë°œë ¥</span><span>${cutDecimal(SGreal.agi, 8)}</span>
          </div>
        `;
        let poisonStats = { hp: u.hp + 2, atk: u.atk + 2, def: u.def + 2, agi: u.agi + 2 };
        for (let i = 0; i < 10; i++) {
          const r = Math.floor(Math.random() * 4);
          if (r === 0) poisonStats.hp++;
          else if (r === 1) poisonStats.atk++;
          else if (r === 2) poisonStats.def++;
          else poisonStats.agi++;
        }
        const total = k * poisonStats.hp + k * poisonStats.atk + k * poisonStats.def + k * poisonStats.agi;
        let down = (total / 100 - 20) / 4;
        if (down < 1) down = 1;
        down = down.toFixed(2);
        const poisonResult = `ğŸ’€ <b>ë§¹ë… ë°ë¯¸ì§€ = ${down}</b>`;
        result.style.display = "block";
        result.innerHTML = decimalResult + poisonResult;
      };
  });

  const safeName = s => (s || "").toLowerCase().trim();
  nameInput.onkeydown = e => { if(e.key === "Enter") updatePet(); };
  document.getElementById("btnSearch").onclick = updatePet;
  nameInput.onchange = updatePet;
  
  function showPetInfo(key) {
    const s = PETS[key].s0;
    currentBase = { name: key, hp: s.hp, atk: s.atk, def: s.def, agi: s.agi };
    sgradeBox.innerHTML = `<b>${key} Sê¸‰ ê¸°ì¤€</b><br>ë‚´êµ¬ë ¥ <b>${s.hp}</b> | ê³µê²©ë ¥ <b>${s.atk}</b> | ë°©ì–´ë ¥ <b>${s.def}</b> | ìˆœë°œë ¥ <b>${s.agi}</b>`;
    totalCost = 0;
    costDisplay.textContent = "ğŸ’° ì´ ì†Œëª¨ : 0ì›";
    resultBox.innerHTML = "";
    resultBox.style.display = "none";
  }

  function updatePet() {
    const n = safeName(nameInput.value);
    const sugBox = document.getElementById("suggestions");
    sugBox.innerHTML = "";
    if (!n) return;
    let key = Object.keys(PETS).find(k => safeName(k) === n);
    if (!key) {
      const partial = Object.keys(PETS).filter(k => safeName(k).includes(n));
      if (partial.length === 1) key = partial[0];
      else if (partial.length > 1) {
        partial.forEach(k => {
          const btn = document.createElement("button");
          btn.textContent = k;
          btn.style.background = "#24324b";
          btn.style.color = "#ffd447";
          btn.style.margin = "3px";
          btn.style.padding = "6px 12px";
          btn.style.borderRadius = "8px";
          btn.style.border = "1px solid #3ba4f7";
          btn.style.cursor = "pointer";
          btn.onclick = () => { nameInput.value = k; sugBox.innerHTML = ""; showPetInfo(k); };
          sugBox.appendChild(btn);
        });
        currentBase = null;
        return;
      }
    }
    if (!key) {
      sgradeBox.innerHTML = `<b style="color:#ff6b81">âš ï¸ [${n}] ë°ì´í„° ì—†ìŒ</b>`;
      currentBase = null;
      return;
    }
    showPetInfo(key);
  }

  function simulate(t = 1) {
    if (!currentBase) { alert("í˜íŠ¸ ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”."); return; }
    resultBox.style.display = "inline-block";
    let o = `<b>${currentBase.name} ì‹œë®¬ë ˆì´ì…˜</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>`;
    o += `<div class="result-header"><span>ë‚´êµ¬ë ¥</span><span>ê³µê²©ë ¥</span><span>ë°©ì–´ë ¥</span><span>ìˆœë°œë ¥</span></div>`;

    for (let i = 1; i <= t; i++) {
      const p = PETS[currentBase.name];
      const tp = { ...p.u };
      tp.hp += Math.floor(Math.random() * 5) - 2;
      tp.atk += Math.floor(Math.random() * 5) - 2;
      tp.def += Math.floor(Math.random() * 5) - 2;
      tp.agi += Math.floor(Math.random() * 5) - 2;

      for (let j = 0; j < 10; j++) {
        const r = Math.floor(Math.random() * 4);
        if (r === 0) tp.hp++;
        else if (r === 1) tp.atk++;
        else if (r === 2) tp.def++;
        else tp.agi++;
      }

      const base = { hp: p.k * tp.hp / 100, atk: p.k * tp.atk / 100, def: p.k * tp.def / 100, agi: p.k * tp.agi / 100 };
      const shown = {
        hp: Math.floor(base.hp * 4 + base.atk + base.def + base.agi),
        atk: Math.floor(base.hp * 0.1 + base.atk + base.def * 0.1 + base.agi * 0.05),
        def: Math.floor(base.hp * 0.1 + base.atk * 0.1 + base.def + base.agi * 0.05),
        agi: Math.floor(base.agi)
      };
      const SstatRaw = p.s0 || { hp: 0, atk: 0, def: 0, agi: 0 };
      const SstatInt = { hp: Math.floor(SstatRaw.hp), atk: Math.floor(SstatRaw.atk), def: Math.floor(SstatRaw.def), agi: Math.floor(SstatRaw.agi) };
      const delta = { hp: shown.hp - SstatInt.hp, atk: shown.atk - SstatInt.atk, def: shown.def - SstatInt.def, agi: shown.agi - SstatInt.agi };
      const formatDelta = n => {
        if (n > 0) return `<span style="color:#00ffff;">(+${n})</span>`;
        if (n < 0) return `<span style="color:#ff0000;">(${n})</span>`;
        return `<span style="color:#ffffff;">(0)</span>`;
      };
      o += `<div class="result-row">
              <span>${shown.hp} ${formatDelta(delta.hp)}</span>
              <span>${shown.atk} ${formatDelta(delta.atk)}</span>
              <span>${shown.def} ${formatDelta(delta.def)}</span>
              <span>${shown.agi} ${formatDelta(delta.agi)}</span>
            </div>`;
    }
    resultBox.innerHTML=o;
  }
  
  function simulateUntilPerfect() {
    if (!currentBase) { alert("í˜íŠ¸ ì´ë¦„ì„ ë¨¼ì € ì…ë ¥í•˜ì„¸ìš”."); return; }
    totalCost = 0; totalCostPerfect = 0;
    costDisplay.textContent = "ğŸ’° ì´ ì†Œëª¨ : 0ì›";
    resultBox.style.display = "inline-block";
    const p = PETS[currentBase.name];
    let runCount = 0;
    const BATCH_SIZE = 5000;
    const MAX_RUNS = 100000; 
    resultBox.innerHTML = `<b>${currentBase.name} ì‹œë®¬ë ˆì´ì…˜</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>ğŸ”¥ ì •ì„ ì´ìƒ ê²€ìƒ‰ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.<br>`;
    costDisplay.textContent = `ğŸ’° ì´ ì†Œëª¨ : ${totalCostPerfect.toLocaleString()}ì› (0íšŒ ì‹œë„ ì¤‘...)`;

    const formatDelta = n => {
      if (n > 0) return `<span style="color:#00ffff;">(+${n})</span>`;
      if (n < 0) return `<span style="color:#ff0000;">(${n})</span>`;
      return `<span style="color:#ffffff;">(0)</span>`;
    };

    function runBatch() {
      for (let i = 0; i < BATCH_SIZE; i++) {
        runCount++;
        totalCostPerfect += 1000;
        if (runCount > MAX_RUNS) {
          totalCostPerfect = 0;
          resultBox.innerHTML = `<b>${currentBase.name} ì‹œë®¬ë ˆì´ì…˜</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>ğŸš« ì •ì„ì´ ë°œê²¬ë˜ì§€ ì•Šì•„ ê²€ìƒ‰ì„ ì¤‘ë‹¨í•©ë‹ˆë‹¤.`;
          costDisplay.textContent = `ğŸš« í•´ë‹¹ í˜íŠ¸ëŠ” ì •ì„ì´ ì¡´ì¬í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.`;
          return;
        }
        const tp = { ...p.u };
        tp.hp += Math.floor(Math.random() * 5) - 2;
        tp.atk += Math.floor(Math.random() * 5) - 2;
        tp.def += Math.floor(Math.random() * 5) - 2;
        tp.agi += Math.floor(Math.random() * 5) - 2;
        for (let j = 0; j < 10; j++) {
          const r = Math.floor(Math.random() * 4);
          if (r === 0) tp.hp++;
          else if (r === 1) tp.atk++;
          else if (r === 2) tp.def++;
          else tp.agi++;
        }
        const base = { hp: p.k * tp.hp / 100, atk: p.k * tp.atk / 100, def: p.k * tp.def / 100, agi: p.k * tp.agi / 100 };
        const shown = {
          hp: Math.floor(base.hp * 4 + base.atk + base.def + base.agi),
          atk: Math.floor(base.hp * 0.1 + base.atk + base.def * 0.1 + base.agi * 0.05),
          def: Math.floor(base.hp * 0.1 + base.atk * 0.1 + base.def + base.agi * 0.05),
          agi: Math.floor(base.agi)
        };
        const SstatRaw = p.s0 || { hp: 0, atk: 0, def: 0, agi: 0 };
        const SstatInt = { hp: Math.floor(SstatRaw.hp), atk: Math.floor(SstatRaw.atk), def: Math.floor(SstatRaw.def), agi: Math.floor(SstatRaw.agi) };
        const delta = { hp: shown.hp - SstatInt.hp, atk: shown.atk - SstatInt.atk, def: shown.def - SstatInt.def, agi: shown.agi - SstatInt.agi };

        if (delta.hp >= 0 && delta.atk >= 0 && delta.def >= 0 && delta.agi >= 0) {
          let o = `<b>${currentBase.name} ì‹œë®¬ë ˆì´ì…˜</b><br>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€<br>ğŸ”¥ ì •ì„ ë°œê²¬! (${runCount.toLocaleString()}íšŒ ì‹œë„)<br>`;
          o += `<div class="result-header"><span>ë‚´êµ¬ë ¥</span><span>ê³µê²©ë ¥</span><span>ë°©ì–´ë ¥</span><span>ìˆœë°œë ¥</span></div>`;
          o += `<div class="result-row">
                  <span>${shown.hp} ${formatDelta(delta.hp)}</span>
                  <span>${shown.atk} ${formatDelta(delta.atk)}</span>
                  <span>${shown.def} ${formatDelta(delta.def)}</span>
                  <span>${shown.agi} ${formatDelta(delta.agi)}</span>
                </div>`;
            resultBox.innerHTML = o;
            costDisplay.textContent = `ğŸ’° ì´ ì†Œëª¨ : ${totalCostPerfect.toLocaleString()}ì›`;
            return; 
          }
        } 
        costDisplay.textContent = `ğŸ’° ì´ ì†Œëª¨ : ${totalCostPerfect.toLocaleString()}ì› (${runCount.toLocaleString()}íšŒ ì‹œë„ ì¤‘...)`;
        setTimeout(runBatch, 0); 
      }
      runBatch();
    }

  document.getElementById("sim1").onclick = () => {
    if (!currentBase) { resultBox.style.display = "inline-block"; resultBox.innerHTML = `<b style="color:#ff6b81;">âš ï¸ ë¨¼ì € í˜íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</b>`; return; }
    simulate(1);
    totalCost += 1000;
    costDisplay.textContent = `ğŸ’° ì´ ì†Œëª¨ : ${totalCost.toLocaleString()}ì›`;
  };
  document.getElementById("sim5").onclick = () => {
    if (!currentBase) { resultBox.style.display = "inline-block"; resultBox.innerHTML = `<b style="color:#ff6b81;">âš ï¸ ë¨¼ì € í˜íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</b>`; return; }
    simulate(5);
    totalCost += 5000;
    costDisplay.textContent = `ğŸ’° ì´ ì†Œëª¨ : ${totalCost.toLocaleString()}ì›`;
  };
  document.getElementById("simUntil").onclick = () => {
    if (!currentBase) { resultBox.style.display = "inline-block"; resultBox.innerHTML = `<b style="color:#ff6b81;">âš ï¸ ë¨¼ì € í˜íŠ¸ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”.</b>`; return; }
    totalCost=0; totalCostPerfect = 0;
    costDisplay.textContent="ğŸ’° ì´ ì†Œëª¨ : 0ì›";
    simulateUntilPerfect();
  };
  document.getElementById("clear").onclick=()=>{ resultBox.innerHTML=""; totalCost=0; totalCostPerfect = 0; costDisplay.textContent="ğŸ’° ì´ ì†Œëª¨ : 0ì›"; resultBox.style.display="none"; };
  document.getElementById("btnClearInput").onclick = () => {
    nameInput.value = ""; 
    document.getElementById("suggestions").innerHTML = "";
    sgradeBox.innerHTML = "í˜íŠ¸ë¥¼ ì…ë ¥í•˜ë©´ Sê¸‰ ê¸°ì¤€ ëŠ¥ë ¥ì¹˜ê°€ í‘œì‹œë©ë‹ˆë‹¤.";
    currentBase = null;
    resultBox.innerHTML=""; totalCost=0; totalCostPerfect = 0; costDisplay.textContent="ğŸ’° ì´ ì†Œëª¨ : 0ì›"; resultBox.style.display="none"; 
  };

  /* ê²½í—˜ì¹˜ ê³„ì‚°ê¸° ë¡œì§ */
  const $=s=>document.querySelector(s);
  const fmtNum=n=>isFinite(n)?Number(n).toLocaleString():"-";
  const EXP_TABLE={1:2,2:6,3:17,4:37,5:67,6:111,7:169,8:247,9:344,10:464,11:609,12:783,13:985,
  14:1221,15:1491,16:1799,17:2145,18:2535,19:2968,20:3448,21:3977,22:4559,23:5193,24:5885,
  25:6635,26:7447,27:8321,28:9263,29:10272,30:11352,31:12506,32:13734,33:15042,34:16429,
  35:17899,36:19454,37:21098,38:22830,39:24656,40:26576,41:28594,42:30710,43:32930,44:35253,
  45:37683,46:40222,47:42874,48:45638,49:48520,50:51520,51:54642,52:57886,53:61258,54:64757,
  55:68387,56:72150,57:76050,58:80086,59:84264,60:106110,61:113412,62:121149,63:129352,
  64:138044,65:147256,66:157019,67:167366,68:178334,69:189958,70:202282,71:215348,72:229205,
  73:243901,74:259495,75:276041,76:293606,77:312258,78:332071,79:353126,80:375511,81:399318,
  82:424655,83:451631,84:480370,85:511007,86:543686,87:578571,88:616838,89:655680,90:698312,
  91:743970,92:795918,93:842442,94:901869,95:962553,96:1026899,97:1098354,98:1174419,99:1256664,
  100:1407463,101:1576358,102:1765521,103:1977384,104:2214670,105:2480430,106:2778082,107:3111451,
  108:3484825,109:3903005,110:4371365,111:4895929,112:5483440,113:6141453,114:6878428,115:7703839,
  116:8628300,117:9663695,118:10823339,119:12122140,120:13576796,121:15206012,122:17030733,
  123:19074421,124:21363352,125:23926954,126:26798189,127:30013971,128:33615648,129:37649526,
  130:42167469,131:47227565,132:52894873,133:59242257,134:66351328,135:74313488,136:83231106,
  137:93218839,138:104405100,139:116933712};
  const getTotalExp=(s,t)=>{let sum=0;for(let lv=s;lv<t;lv++)if(EXP_TABLE[lv])sum+=EXP_TABLE[lv];return sum;};
  $("#run").onclick=()=>{
    try{
      const c=+$("#currentLevel").value,cp=+($("#currentPercent").value)||0,t=+$("#targetLevel").value,ph=+$("#xpPerHour").value;
      if(!c||!t||!ph)throw new Error("ì…ë ¥ì´ ë¶€ì¡±í•©ë‹ˆë‹¤.");
      if(t<=c)throw new Error("ëª©í‘œ ë ˆë²¨ì€ í˜„ì¬ë³´ë‹¤ ì»¤ì•¼ í•©ë‹ˆë‹¤.");
      const rem1=EXP_TABLE[c]*(1-(cp/100)),rem2=getTotalExp(c+1,t),remain=rem1+rem2;
      const hrs=remain/ph,days=hrs/24,h=Math.floor(hrs),m=Math.round((hrs-h)*60);
      $("#statRemain").textContent=fmtNum(remain.toFixed(0));
      $("#statTimeAndDays").textContent=`${h}ì‹œê°„ ${m}ë¶„ (${days.toFixed(2)}ì¼)`;
      $("#results").hidden=false;
    }catch(e){alert(e.message);}
  };
  $("#reset").onclick=()=>{document.querySelectorAll("#expTab input").forEach(i=>i.value="");$("#results").hidden=true;};
});
</script>
</body>
</html>